# Task 5 ‚Äî –ë–∞–∑–æ–≤—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

## üéØ –¶–µ–ª–∏

- ‚úÖ OpenTelemetry + Prometheus exporter
- ‚úÖ `otelhttp` middleware –¥–ª—è Twirp
- ‚úÖ –ë–∞–∑–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏: request count, latency, error rate
- ‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å trace ID

## üìä –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

### 1. OpenTelemetry –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è

**–§–∞–π–ª:** `internal/otel/config.go`

```go
// InitOpenTelemetry initializes OpenTelemetry with Prometheus exporter
func InitOpenTelemetry(ctx context.Context, serviceName string) (func(context.Context) error, error)
```

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**

- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Prometheus exporter –¥–ª—è –º–µ—Ç—Ä–∏–∫
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ tracer provider –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ —Ç—Ä–µ–π—Å–∏–Ω–≥–∞
- Graceful shutdown –¥–ª—è OpenTelemetry providers
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤ (service name, version, environment)

### 2. otelhttp middleware

**–§–∞–π–ª:** `internal/httpx/otel.go`

```go
// OTelMiddleware returns OpenTelemetry HTTP middleware for automatic tracing
func OTelMiddleware() func(http.Handler) http.Handler
```

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**

- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç—Ä–µ–π—Å–∏–Ω–≥ –≤—Å–µ—Ö HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
- –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ span names (Method + Path)
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º middleware chain

### 3. –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å trace ID

**–§–∞–π–ª:** `internal/httpx/logger.go`

**–û–±–Ω–æ–≤–ª–µ–Ω–∏—è:**

- –î–æ–±–∞–≤–ª–µ–Ω trace ID –≤ –ª–æ–≥–∏ HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
- –£–ª—É—á—à–µ–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ª–æ–≥–æ–≤ —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ –ø–æ–ª—è–º–∏:
  - `http_method`
  - `http_path`
  - `http_status`
  - `trace_id`
  - `http_user_agent`
  - `http_remote_addr`

**–ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è:**

```go
// LogWithTrace adds trace ID to log attributes
func LogWithTrace(ctx context.Context, level slog.Level, msg string, attrs ...any)
```

### 4. Health checks

**–§–∞–π–ª:** `internal/health/health.go`

**–≠–Ω–¥–ø–æ–∏–Ω—Ç—ã:**

- `/health` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞
- `/ready` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ —Ä–∞–±–æ—Ç–µ

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**

- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ MongoDB
- JSON –æ—Ç–≤–µ—Ç—ã —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ (200/503)

### 5. Prometheus –º–µ—Ç—Ä–∏–∫–∏ (–≥–æ—Ç–æ–≤—ã –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏)

**–§–∞–π–ª:** `internal/metrics/metrics.go`

**–ú–µ—Ç—Ä–∏–∫–∏:**

- `http_requests_total` - —Å—á–µ—Ç—á–∏–∫ HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
- `http_request_duration_seconds` - –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
- `http_requests_in_progress` - —Ç–µ–∫—É—â–∏–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
- `twirp_requests_total` - –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è Twirp –º–µ—Ç–æ–¥–æ–≤

## üöÄ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ —Å–µ—Ä–≤–µ—Ä

**–§–∞–π–ª:** `cmd/server/main.go`

**–û—Å–Ω–æ–≤–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**

- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è OpenTelemetry –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ middleware chain:
  - `httpx.OTelMiddleware()` - —Ç—Ä–µ–π—Å–∏–Ω–≥
  - `httpx.Logger()` - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å trace ID
  - `httpx.Recovery()` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞–Ω–∏–∫
- Health check endpoints
- Graceful shutdown —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º OpenTelemetry

## üìà –î–æ—Å—Ç—É–ø–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

| –≠–Ω–¥–ø–æ–∏–Ω—Ç | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|----------|------------|
| `/` | –û—Å–Ω–æ–≤–Ω–æ–π endpoint |
| `/twirp/*` | Twirp API |
| `/health` | Health check |
| `/ready` | Readiness check |
| `/metrics` | Prometheus –º–µ—Ç—Ä–∏–∫–∏ |

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
OPENAI_API_KEY=your_openai_key
MONGO_URI=mongodb://localhost:27017
```

### OpenTelemetry –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

- Service name: `go-ai-assistant`
- Environment: `development`
- Version: `1.0.0`

## üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

### Observability

- **–¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞**: —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π —Ç—Ä–µ–π—Å–∏–Ω–≥ –≤—Å–µ—Ö HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
- **–ú–µ—Ç—Ä–∏–∫–∏**: –≥–æ—Ç–æ–≤—ã–µ Prometheus –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏ —Å trace ID –¥–ª—è ELK stack

### Production Readiness

- **Health checks**: –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- **Graceful shutdown**: –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã
- **Error handling**: –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞–Ω–∏–∫ –∏ –æ—à–∏–±–æ–∫

### Developer Experience

- **–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç—Ä–µ–π—Å–∏–Ω–≥ –±–µ–∑ —Ä—É—á–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- **–°—Ç—Ä—É–∫—Ç—É—Ä–∞**: –µ–¥–∏–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –ª–æ–≥–æ–≤ –¥–ª—è –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è**: –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ CI/CD –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥—É

## üîÑ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –î–ª—è –ø–æ–ª–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –º–µ—Ç—Ä–∏–∫

1. –ò—Å–ø—Ä–∞–≤–∏—Ç—å —Ç–∏–ø—ã –≤ `internal/otel/config.go`
2. –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ –≤ `cmd/server/main.go`
3. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å `/metrics` endpoint

### –î–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

1. –î–æ–±–∞–≤–∏—Ç—å Jaeger/Zipkin –¥–ª—è —Ç—Ä–µ–π—Å–∏–Ω–≥–∞
2. –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å Grafana –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
3. –î–æ–±–∞–≤–∏—Ç—å –∞–ª–µ—Ä—Ç—ã –≤ Prometheus
4. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å ELK stack –¥–ª—è –ª–æ–≥–æ–≤

## üìä –û–∂–∏–¥–∞–µ–º—ã–µ –º–µ—Ç—Ä–∏–∫–∏

–ü–æ—Å–ª–µ –ø–æ–ª–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã:

- **Request Rate**: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ —Å–µ–∫—É–Ω–¥—É
- **Error Rate**: –ø—Ä–æ—Ü–µ–Ω—Ç –æ—à–∏–±–æ–∫
- **Latency**: –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ (p50, p95, p99)
- **Throughput**: –ø—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å
- **Resource Usage**: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ CPU –∏ –ø–∞–º—è—Ç–∏

**Task 5 —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω! –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –¥–ª—è –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å –±–∞–∑–æ–≤—ã–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º.**
